# AWS Penetration Testing Scenarios dengan LocalStack

## üéØ Overview
Dokumen ini berisi berbagai scenario penetration testing AWS yang dapat dipraktikkan menggunakan LocalStack untuk pembelajaran cybersecurity.

## üìã Prerequisites
- LocalStack running (docker-compose up -d)
- AWS CLI configured
- Python dengan boto3
- Basic knowledge tentang AWS services

## üîç Scenario 1: S3 Bucket Misconfiguration

### Target: Misconfigured S3 Buckets
**Vulnerability**: Public read/write permissions, sensitive data exposure

### Setup Vulnerable Environment:
```bash
# Buat bucket dengan public read
aws --endpoint-url=http://localhost:4566 s3 mb s3://vulnerable-bucket-public

# Upload sensitive file
echo "username:admin
password:password123
api_key:sk-1234567890abcdef" > sensitive-data.txt

aws --endpoint-url=http://localhost:4566 s3 cp sensitive-data.txt s3://vulnerable-bucket-public/

# Set public read policy
aws --endpoint-url=http://localhost:4566 s3api put-bucket-policy --bucket vulnerable-bucket-public --policy '{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::vulnerable-bucket-public/*"
    }
  ]
}'
```

### Penetration Testing Steps:
1. **Reconnaissance**: Discover buckets
2. **Enumeration**: List bucket contents
3. **Exploitation**: Download sensitive files
4. **Impact Assessment**: Evaluate data exposure

---

## üîç Scenario 2: IAM Privilege Escalation

### Target: Overprivileged IAM Roles
**Vulnerability**: Excessive permissions, privilege escalation paths

### Setup:
```bash
# Buat IAM user dengan limited permissions tapi bisa create roles
aws --endpoint-url=http://localhost:4566 iam create-user --user-name limited-user

# Attach policy yang memungkinkan privilege escalation
aws --endpoint-url=http://localhost:4566 iam create-policy --policy-name PrivEscPolicy --policy-document '{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iam:CreateRole",
        "iam:AttachRolePolicy",
        "iam:AssumeRole"
      ],
      "Resource": "*"
    }
  ]
}'
```

### Attack Vector:
1. Create new role with admin permissions
2. Assume the role
3. Gain full access

---

## üîç Scenario 3: Lambda Function Code Injection

### Target: Vulnerable Lambda Functions
**Vulnerability**: Code injection, insecure dependencies

### Setup Vulnerable Lambda:
```python
# vulnerable_lambda.py
import json
import subprocess

def lambda_handler(event, context):
    # VULNERABLE: Direct command execution
    command = event.get('command', 'echo hello')
    result = subprocess.run(command, shell=True, capture_output=True, text=True)
    
    return {
        'statusCode': 200,
        'body': json.dumps({
            'output': result.stdout,
            'error': result.stderr
        })
    }
```

### Attack Scenarios:
1. Command injection
2. Environment variable extraction
3. File system access

---

## üîç Scenario 4: DynamoDB NoSQL Injection

### Target: DynamoDB Query Injection
**Vulnerability**: Improper input validation in queries

### Vulnerable Code Example:
```python
# vulnerable_dynamodb_query.py
import boto3
import json

def query_user_data(user_id):
    # VULNERABLE: Direct string concatenation
    dynamodb = boto3.resource('dynamodb', endpoint_url='http://localhost:4566')
    table = dynamodb.Table('users')
    
    # This is vulnerable to NoSQL injection
    response = table.scan(
        FilterExpression=f"user_id = {user_id}"
    )
    return response['Items']
```

---

## üîç Scenario 5: API Gateway Security Bypass

### Target: Insecure API endpoints
**Vulnerability**: Authentication bypass, CORS misconfiguration

### Setup:
- API Gateway with weak authentication
- CORS misconfiguration
- Rate limiting bypass

---

## üîç Scenario 6: CloudFormation Template Injection

### Target: Infrastructure as Code vulnerabilities
**Vulnerability**: Template injection, resource hijacking

### Vulnerable Template:
```yaml
# vulnerable-template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  UserInput:
    Type: String
    Default: "user-input"

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref UserInput  # VULNERABLE: User input directly used
```

---

## üõ†Ô∏è Penetration Testing Methodology

### Phase 1: Reconnaissance
- [ ] Service discovery
- [ ] Permission enumeration
- [ ] Resource mapping

### Phase 2: Vulnerability Assessment
- [ ] Configuration review
- [ ] Permission analysis
- [ ] Code review (Lambda functions)

### Phase 3: Exploitation
- [ ] Privilege escalation
- [ ] Data exfiltration
- [ ] Lateral movement

### Phase 4: Post-Exploitation
- [ ] Persistence
- [ ] Coverage tracks
- [ ] Impact assessment

### Phase 5: Reporting
- [ ] Vulnerability documentation
- [ ] Risk assessment
- [ ] Remediation recommendations

---

## üîß Essential Tools

### AWS-specific Tools:
- **Scout Suite**: AWS security auditing
- **Prowler**: AWS security best practices
- **Pacu**: AWS exploitation framework
- **CloudMapper**: AWS environment visualization

### General Tools:
- **Burp Suite**: Web application testing
- **Nmap**: Network scanning
- **Metasploit**: Exploitation framework
- **Custom scripts**: Python/Bash automation

---

## üìö Learning Objectives

Setelah menyelesaikan scenarios ini, Anda akan memahami:

1. **AWS Security Model**: IAM, resource policies, service permissions
2. **Common Misconfigurations**: S3 buckets, IAM roles, security groups
3. **Attack Vectors**: Privilege escalation, data exfiltration, code injection
4. **Detection Methods**: CloudTrail analysis, monitoring patterns
5. **Remediation Strategies**: Security hardening, best practices

---

## ‚ö†Ô∏è Ethical Considerations

**PENTING**: Scenarios ini hanya untuk educational purposes:
- Gunakan hanya di environment LocalStack
- Jangan test di AWS production tanpa authorization
- Follow responsible disclosure jika menemukan vulnerability real
- Respect terms of service dan legal boundaries

---

## üéØ Next Steps

1. Start dengan Scenario 1 (S3 Misconfiguration)
2. Practice dengan tools yang disediakan
3. Document findings dan methodology
4. Expand ke scenarios yang lebih complex
5. Develop custom exploitation scripts